<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>圖片封裝 V46 (番號自主版)</title>
    <style>
        :root { --primary: #ff4757; --bg: #0f0f0f; --panel: #1e1e1e; --text: #e0e0e0; }
        * { box-sizing: border-box; }
        body { font-family: "Segoe UI", sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* 左側邊欄 */
        .sidebar { width: 380px; background: var(--panel); border-right: 1px solid #333; display: flex; flex-direction: column; padding: 15px; flex-shrink: 0; z-index: 100; }
        h1 { font-size: 18px; margin: 0 0 15px 0; color: var(--primary); text-align: center; }
        
        #inputGroups { flex: 1; overflow-y: auto; margin-bottom: 15px; padding-right: 5px; }
        .input-card { background: #2a2a2a; border-radius: 8px; padding: 12px; margin-bottom: 15px; border: 1px solid #444; }
        .input-card input { width: 100%; background: #1a1a1a; border: 1px solid #555; color: #ff9f1a; border-radius: 4px; padding: 8px; margin-bottom: 8px; font-weight: bold; }
        .input-card textarea { width: 100%; background: #1a1a1a; border: 1px solid #333; color: #ccc; border-radius: 4px; padding: 8px; height: 80px; font-size: 11px; resize: none; display: block; }
        
        .btn-add-group { width: 100%; padding: 8px; background: #333; border: 1px dashed #666; color: #aaa; border-radius: 6px; cursor: pointer; margin-bottom: 15px; }
        .btn-group-main { display: flex; gap: 8px; margin-bottom: 15px; }
        .btn-scan { flex: 2; padding: 12px; background: var(--primary); border: none; color: #fff; font-weight: bold; border-radius: 6px; cursor: pointer; }
        .btn-clear { flex: 1; padding: 12px; background: #444; border: none; color: #fff; border-radius: 6px; cursor: pointer; }

        /* 任務列表：番號輸入框優化 */
        .task-container { height: 180px; overflow-y: auto; background: #121212; border-radius: 8px; border: 1px solid #333; }
        .task-item { padding: 8px 12px; border-bottom: 1px solid #222; cursor: pointer; display: flex; align-items: center; gap: 8px; }
        .task-item.active { background: #3a1a1c; border-left: 4px solid var(--primary); }
        
        /* 讓使用者可以點擊並編輯的番號框 */
        .edit-id-input { 
            background: #000; 
            border: 1px solid #555; 
            color: #ff4757; 
            font-weight: bold; 
            padding: 4px 8px; 
            border-radius: 4px; 
            width: 140px; 
            font-size: 13px;
            cursor: text;
        }
        .edit-id-input:focus { border-color: #ff9f1a; outline: none; background: #111; }
        .task-actor-label { font-size: 11px; color: #888; flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* 右側主內容區 */
        .main-content { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }
        .top-bar { padding: 0 25px; background: #1a1a1a; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; height: 60px; flex-shrink: 0; }
        
        #gallery { flex: 1; overflow-y: scroll; padding: 25px; display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); grid-auto-rows: min-content; gap: 20px; align-content: start; }

        .card { background: #1e1e1e; border-radius: 8px; position: relative; border: 2px solid #333; width: 100%; aspect-ratio: 16 / 9; overflow: hidden; }
        .card.selected { border-color: var(--primary); }
        .card img { width: 100%; height: 100%; object-fit: cover; display: block; cursor: zoom-in; }

        /* 下載工具列 */
        .footer-bar { padding: 15px 30px; background: #1a1a1a; border-top: 1px solid #333; display: none; flex-direction: column; gap: 10px; flex-shrink: 0; }
        .download-config { display: flex; align-items: center; gap: 15px; background: #252525; padding: 10px 15px; border-radius: 8px; border: 1px solid #444; }
        .filename-input { flex: 1; background: #000; border: 1px solid #555; color: #2ed573; padding: 8px; border-radius: 4px; font-family: monospace; font-size: 14px; }

        .btn-download { width: 100%; padding: 16px; background: var(--primary); border: none; color: #fff; font-weight: bold; border-radius: 10px; cursor: pointer; font-size: 16px; }
        
        .check-area { position: absolute; top: 0; right: 0; width: 50px; height: 50px; display: flex; justify-content: flex-end; padding: 8px; cursor: pointer; z-index: 20; }
        .check-box { width: 24px; height: 24px; border-radius: 4px; border: 2px solid #fff; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; }
        .card.selected .check-box { background: var(--primary); border-color: var(--primary); }
        .card.selected .check-box::after { content: '✓'; color: white; font-size: 14px; font-weight: bold; }
        .tag { position: absolute; bottom: 8px; left: 8px; font-size: 10px; padding: 2px 8px; background: rgba(0,0,0,0.8); border-radius: 4px; color: #fff; z-index: 10; }

        #lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; z-index: 10000; }
        #lightbox img { max-width: 98%; max-height: 98%; object-fit: contain; }
    </style>
</head>
<body>

<div class="sidebar">
    <h1>DOWNLOAD V46</h1>
    <div id="inputGroups">
        <div class="input-card">
            <input type="text" placeholder="演員名稱" class="group-actor">
            <textarea placeholder="貼上網址 (一行一個)" class="group-urls"></textarea>
        </div>
    </div>
    <button class="btn-add-group" onclick="addGroup()">+ 增加一組演員</button>
    <div class="btn-group-main">
        <button class="btn-scan" onclick="initTasks()">開始批次掃描</button>
        <button class="btn-clear" onclick="clearAll()">全部清除</button>
    </div>
    <div class="task-container" id="taskList"></div>
</div>

<div class="main-content">
    <div class="top-bar">
        <div id="currentTaskLabel" style="font-weight: bold; color: #ff9f1a;">等待掃描...</div>
        <div id="selectionTools" style="display:none;">
            <button onclick="toggleAll(true)" style="padding:8px 15px; background:#333; color:#ccc; border:1px solid #555; border-radius:6px; font-size:12px; cursor:pointer;">全選內容</button>
            <button onclick="toggleAll(false)" style="padding:8px 15px; background:#333; color:#ccc; border:1px solid #555; border-radius:6px; font-size:12px; margin-left:10px; cursor:pointer;">取消全選</button>
        </div>
    </div>
    
    <div id="gallery"></div>
    
    <div class="footer-bar" id="footerBar">
        <div class="download-config">
            <span style="font-size: 13px; color: #aaa;">檔名範本：</span>
            <input type="text" id="nameTemplate" class="filename-input" value="{ID}_{ACTOR}_{INDEX}">
        </div>
        <div style="display:flex; justify-content: space-between; align-items: center;">
            <div style="font-size: 16px;">已選：<b id="countText" style="color:var(--primary);">0</b> 張</div>
            <div style="font-size: 11px; color: #555;">提示：左側紅框番號可直接手動修改</div>
        </div>
        <button class="btn-download" id="dlBtn" onclick="startDownload()">確認下載 (使用自訂番號)</button>
    </div>
</div>

<div id="lightbox" onclick="this.style.display='none'"><img id="lbImg"></div>

<script>
    let tasks = [];
    let activeTaskIdx = null;
    const proxy = (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`;

    function addGroup() {
        const container = document.getElementById('inputGroups');
        const div = document.createElement('div');
        div.className = 'input-card';
        div.innerHTML = `<input type="text" placeholder="演員名稱" class="group-actor"><textarea placeholder="貼上網址 (一行一個)" class="group-urls"></textarea>`;
        container.appendChild(div);
    }

    async function initTasks() {
        tasks = [];
        const cards = document.querySelectorAll('.input-card');
        cards.forEach(card => {
            const actor = card.querySelector('.group-actor').value.trim();
            const urls = card.querySelector('.group-urls').value.trim().split('\n');
            if (!actor || urls.length === 0 || (urls.length === 1 && urls[0] === "")) return;
            urls.forEach(url => {
                url = url.trim();
                if (!url.startsWith('http')) return;
                const urlParts = url.replace(/\/$/, "").split('/');
                const rawID = urlParts.pop();
                const cleanID = rawID.includes('_') ? rawID.split('_').pop() : rawID;
                const prefixMatch = cleanID.match(/[a-zA-Z]+/);
                const numberMatch = cleanID.match(/\d+/);
                if (prefixMatch && numberMatch) {
                    const finalID = `${prefixMatch[0].toUpperCase()}-${numberMatch[0].padStart(3, '0').slice(-3)}`;
                    tasks.push({ url, rawID, finalID, actor, images: [], status: 'pending', fetched: false });
                }
            });
        });
        if (tasks.length === 0) return;
        renderTaskList();
        selectTask(0);
    }

    function renderTaskList() {
        const list = document.getElementById('taskList');
        list.innerHTML = tasks.map((t, i) => `
            <div class="task-item ${activeTaskIdx === i ? 'active' : ''}" onclick="selectTask(${i})">
                <input type="text" class="edit-id-input" value="${t.finalID}" 
                    onclick="event.stopPropagation()" 
                    oninput="tasks[${i}].finalID = this.value; updateTitle(${i});">
                <span class="task-actor-label">${t.actor}</span>
                <div class="status-dot ${t.status === 'done' ? 'done' : ''}"></div>
            </div>`).join('');
    }

    function updateTitle(idx) {
        if(activeTaskIdx === idx) {
            document.getElementById('currentTaskLabel').innerText = `目前查看：${tasks[idx].finalID} (${tasks[idx].actor})`;
        }
    }

    async function selectTask(idx) {
        activeTaskIdx = idx; renderTaskList();
        const task = tasks[idx];
        document.getElementById('currentTaskLabel').innerText = `目前查看：${task.finalID} (${task.actor})`;
        document.getElementById('gallery').innerHTML = '';
        if (!task.fetched) {
            document.getElementById('gallery').innerHTML = '<div style="grid-column:1/-1; text-align:center; padding-top:100px; color:#888;">網頁掃描中...</div>';
            await fetchImages(task);
        } else { renderGallery(); }
    }

    async function fetchImages(task) {
        try {
            const res = await fetch(proxy(task.url));
            const html = await res.text();
            const doc = new DOMParser().parseFromString(html, 'text/html');
            extractFromDoc(doc, task, task.url);
            let targetLinks = Array.from(doc.querySelectorAll('a')).filter(a => a.querySelector('img')).map(a => new URL(a.getAttribute('href'), task.url).href);
            const uniqueLinks = [...new Set(targetLinks)];
            for (let pageUrl of uniqueLinks) {
                try {
                    const subRes = await fetch(proxy(pageUrl));
                    const subDoc = new DOMParser().parseFromString(await subRes.text(), 'text/html');
                    extractFromDoc(subDoc, task, pageUrl);
                } catch(e) {}
            }
            task.fetched = true;
            renderGallery();
        } catch (e) { document.getElementById('gallery').innerHTML = '解析失敗'; }
    }

    function extractFromDoc(doc, task, baseUrl) {
        const imgs = Array.from(doc.querySelectorAll('img'));
        imgs.forEach(img => {
            let src = img.getAttribute('src') || img.getAttribute('data-src') || img.getAttribute('data-lazy-src');
            if (!src) return;
            let absUrl = new URL(src, baseUrl).href;
            let originalUrl = absUrl.replace(/-\d+x\d+(?=\.(jpg|jpeg|png))/i, '');
            let fileName = decodeURIComponent(originalUrl.split('/').pop().split('?')[0]);
            const isCover = fileName.toLowerCase().includes(task.rawID.toLowerCase() + 'pl');
            const isContent = fileName.toLowerCase().includes(task.rawID.toLowerCase() + '_');
            const isThumbnail = fileName.includes('-');
            if ((isCover || isContent) && !isThumbnail) {
                if (!task.images.find(m => m.url === originalUrl)) {
                    task.images.push({ url: originalUrl, selected: isCover, type: isCover ? '封面' : '內容' });
                }
            }
        });
    }

    function renderGallery() {
        const task = tasks[activeTaskIdx];
        const gallery = document.getElementById('gallery');
        if (task.images.length === 0) {
            gallery.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding-top:100px; color:#888;">找不到圖片。</div>';
            return;
        }
        gallery.innerHTML = task.images.map((img, i) => `
            <div class="card ${img.selected ? 'selected' : ''}" id="card-${i}">
                <div class="tag">${img.type}</div>
                <div class="check-area" onclick="toggleImg(event, ${i})"><div class="check-box"></div></div>
                <img src="${img.url}" loading="lazy" onclick="openLB('${img.url}')">
            </div>`).join('');
        document.getElementById('footerBar').style.display = 'flex';
        document.getElementById('selectionTools').style.display = 'block';
        updateCount();
    }

    function toggleImg(e, i) {
        e.stopPropagation();
        const img = tasks[activeTaskIdx].images[i];
        img.selected = !img.selected;
        document.getElementById(`card-${i}`).classList.toggle('selected');
        updateCount();
    }

    function toggleAll(state) {
        tasks[activeTaskIdx].images.forEach((img, i) => {
            if (img.type !== '封面') {
                img.selected = state;
                const card = document.getElementById(`card-${i}`);
                if(card) card.classList.toggle('selected', state);
            }
        });
        updateCount();
    }

    function updateCount() {
        document.getElementById('countText').innerText = tasks[activeTaskIdx].images.filter(i => i.selected).length;
    }

    function openLB(url) {
        document.getElementById('lbImg').src = url;
        document.getElementById('lightbox').style.display = 'flex';
    }

    function clearAll() {
        if(!confirm("確定清空所有任務？")) return;
        location.reload();
    }

    async function startDownload() {
        const task = tasks[activeTaskIdx];
        const selected = task.images.filter(i => i.selected);
        const btn = document.getElementById('dlBtn');
        let template = document.getElementById('nameTemplate').value.trim() || "{ID}_{ACTOR}_{INDEX}";

        btn.disabled = true; btn.innerText = "下載發送中...";
        let contentIdx = 1;
        for (let item of selected) {
            const ext = item.url.split('.').pop().split('?')[0];
            
            // 下載時讀取「當前」輸入框中的 ID
            let finalFileName = template
                .replace(/{ID}/g, task.finalID)
                .replace(/{ACTOR}/g, task.actor)
                .replace(/{INDEX}/g, String(contentIdx++).padStart(2, '0'));

            if (item.type === '封面') finalFileName = "!" + finalFileName + "_封面";
            finalFileName += "." + ext;

            try {
                const resp = await fetch(proxy(item.url));
                const blob = await resp.blob();
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob); a.download = finalFileName; a.click();
                await new Promise(r => setTimeout(r, 600));
            } catch(e) {}
        }
        btn.disabled = false; btn.innerText = "確認下載 (使用自訂番號)";
        task.status = 'done'; renderTaskList();
    }
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') document.getElementById('lightbox').style.display = 'none'; });
</script>
</body>
</html>
