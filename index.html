<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é«˜æ¸…åœ–ç‰‡å°è£ App</title>
    <meta name="theme-color" content="#ff4757">
    <link rel="apple-touch-icon" href="https://via.placeholder.com/192/ff4757/fff?text=IMG">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root { --primary: #ff4757; --bg: #121212; --card: #1e1e1e; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, "Microsoft JhengHei", sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 15px; padding-bottom: 80px; }
        
        .header { background: var(--card); padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); }
        h1 { font-size: 20px; margin: 0 0 15px 0; color: var(--primary); text-align: center; }
        
        .input-group { display: flex; flex-direction: column; gap: 10px; }
        input { width: 100%; padding: 15px; border-radius: 10px; border: 1px solid #333; background: #252525; color: #fff; font-size: 16px; }
        
        /* æ‰‹æ©Ÿç‰ˆæŒ‰éˆ•å„ªåŒ– */
        .btn-main { width: 100%; padding: 15px; background: var(--primary); border: none; border-radius: 10px; color: #fff; font-weight: bold; font-size: 16px; cursor: pointer; }
        .btn-main:active { opacity: 0.8; transform: scale(0.98); }

        /* ä¸‹è¼‰æ§åˆ¶å°ï¼ˆå›ºå®šåœ¨åº•éƒ¨ï¼‰ */
        .download-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #252525; padding: 15px; display: none; border-top: 1px solid #333; z-index: 100; box-shadow: 0 -5px 15px rgba(0,0,0,0.5); }
        
        #gallery { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 20px; }
        .card { background: var(--card); border-radius: 10px; overflow: hidden; position: relative; border: 1px solid #333; }
        .card img { width: 100%; height: 150px; object-fit: contain; background: #000; }
        .badge { position: absolute; top: 5px; left: 5px; padding: 3px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; background: #3498db; }
        .badge.content { background: #2ed573; }
        .filename { font-size: 11px; padding: 8px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }

        #status { font-size: 13px; color: #ffa502; text-align: center; margin-top: 10px; }
        .loading-spin { display: inline-block; width: 12px; height: 12px; border: 2px solid #fff; border-top-color: transparent; border-radius: 50%; animate: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="header">
    <h1>ğŸ“¸ é«˜æ¸…åœ–ç‰‡å°è£ App</h1>
    <div class="input-group">
        <input type="text" id="actorName" placeholder="è¼¸å…¥æ¼”å“¡å§“å (ç”¨æ–¼è³‡æ–™å¤¾å‘½å)">
        <input type="text" id="urlInput" placeholder="è²¼ä¸Šç¶²å€ (ç•ªè™Ÿé é¢)">
        <button class="btn-main" onclick="fetchImages()">é–‹å§‹æƒæ</button>
    </div>
    <div id="status"></div>
</div>

<div id="gallery"></div>

<div id="downloadBar" class="download-bar">
    <button class="btn-main" id="zipBtn" onclick="downloadZip()">å°è£ä¸¦ä¸‹è¼‰ ZIP (.zip)</button>
    <div id="zipStatus" style="font-size: 12px; text-align: center; margin-top: 5px; color: #888;"></div>
</div>

<script>
    let imageList = []; // å„²å­˜å¾…ä¸‹è¼‰çš„æ¸…å–®

    async function fetchImages() {
        const actor = document.getElementById('actorName').value.trim() || 'æœªçŸ¥åæ¼”å“¡';
        const url = document.getElementById('urlInput').value.trim();
        const status = document.getElementById('status');
        const gallery = document.getElementById('gallery');
        const downloadBar = document.getElementById('downloadBar');

        if (!url) return alert('è«‹è¼¸å…¥ç¶²å€');
        
        // æå–ç•ªè™Ÿ
        const urlParts = url.replace(/\/$/, "").split('/');
        const targetID = urlParts[urlParts.length - 1];

        gallery.innerHTML = '';
        imageList = [];
        downloadBar.style.display = 'none';
        status.innerHTML = '<span class="loading-spin"></span> æ­£åœ¨ç©¿é€æŠ“å–...';

        try {
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
            const response = await fetch(proxyUrl);
            const html = await response.text();
            const doc = new DOMParser().parseFromString(html, 'text/html');
            const imgs = Array.from(doc.querySelectorAll('img'));

            imgs.forEach(img => {
                let src = img.getAttribute('src') || img.getAttribute('data-src');
                if (!src) return;
                let absUrl = new URL(src, url).href;
                let originalUrl = absUrl.replace(/-\d+x\d+(?=\.(jpg|jpeg|png))/i, '');
                let fileName = decodeURIComponent(originalUrl.split('/').pop().split('?')[0]);

                const isCover = fileName.toLowerCase().includes(targetID.toLowerCase() + 'pl');
                const isContent = fileName.toLowerCase().includes(targetID.toLowerCase() + '_');
                const isThumbnail = fileName.includes('-');

                if ((isCover || isContent) && !isThumbnail) {
                    if (!imageList.find(i => i.url === originalUrl)) {
                        const type = isCover ? 'å°é¢' : 'å…§å®¹';
                        // ä¾ç…§ä½ çš„è¦æ±‚è¨­å®šå…§éƒ¨æª”å
                        const saveName = isCover ? `å°é¢.${fileName.split('.').pop()}` : fileName;
                        
                        imageList.push({ url: originalUrl, saveName, type, actor, targetID });
                        renderCard(originalUrl, saveName, type);
                    }
                }
            });

            if (imageList.length > 0) {
                status.innerText = `æˆåŠŸæ‰¾åˆ° ${imageList.length} å¼µåœ–ç‰‡`;
                downloadBar.style.display = 'block';
            } else {
                status.innerText = 'æ‰¾ä¸åˆ°ç¬¦åˆè¦å‰‡çš„åœ–ç‰‡';
            }

        } catch (e) {
            status.innerText = 'é€£ç·šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦';
        }
    }

    function renderCard(url, name, type) {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
            <span class="badge ${type === 'å…§å®¹' ? 'content' : ''}">${type}</span>
            <img src="${url}" loading="lazy">
            <span class="filename">${name}</span>
        `;
        document.getElementById('gallery').appendChild(div);
    }

    async function downloadZip() {
        if (imageList.length === 0) return;
        const zipBtn = document.getElementById('zipBtn');
        const zipStatus = document.getElementById('zipStatus');
        const zip = new JSZip();
        
        zipBtn.disabled = true;
        zipStatus.innerText = 'æ­£åœ¨å°è£æª”æ¡ˆï¼Œè«‹å‹¿é›¢é–‹é é¢...';

        try {
            for (let i = 0; i < imageList.length; i++) {
                const item = imageList[i];
                zipStatus.innerText = `ä¸‹è¼‰ä¸­ (${i + 1}/${imageList.length})`;
                
                // é€éä»£ç†æŠ“å–åœ–ç‰‡äºŒé€²åˆ¶è³‡æ–™
                const imgResp = await fetch(`https://corsproxy.io/?${encodeURIComponent(item.url)}`);
                const blob = await imgResp.blob();
                
                // å»ºç«‹è³‡æ–™å¤¾å±¤ç´šï¼šæ¼”å“¡ / ç•ªè™Ÿ / æª”å
                const folderPath = `${item.actor}/${item.targetID}/${item.saveName}`;
                zip.file(folderPath, blob);
            }

            zipStatus.innerText = 'æ­£åœ¨å£“ç¸®...';
            const content = await zip.generateAsync({ type: "blob" });
            saveAs(content, `${imageList[0].targetID}_${imageList[0].actor}.zip`);
            zipStatus.innerText = 'ä¸‹è¼‰å®Œæˆï¼';
        } catch (e) {
            alert('å°è£å¤±æ•—ï¼Œéƒ¨åˆ†åœ–ç‰‡å¯èƒ½é™åˆ¶æŠ“å–');
        } finally {
            zipBtn.disabled = false;
        }
    }
</script>
</body>
</html>
