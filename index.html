<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ–ç‰‡å°è£ V7 (ä¸‰æ¬„ 16:9)</title>
    <meta name="theme-color" content="#ff4757">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root { --primary: #ff4757; --bg: #121212; --card: #1e1e1e; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 10px; padding-bottom: 120px; }
        
        .header { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #333; margin-bottom: 15px; }
        h1 { font-size: 18px; margin: 0 0 12px 0; color: var(--primary); text-align: center; }
        input[type="text"] { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #252525; color: #fff; font-size: 16px; margin-bottom: 10px; outline: none; }
        
        .control-btns { display: flex; gap: 5px; margin-bottom: 15px; display: none; }
        .btn-small { flex: 1; padding: 8px; font-size: 11px; border-radius: 5px; border: 1px solid #444; background: #333; color: #ccc; cursor: pointer; }

        /* ä¸€æ’ä¸‰å¼µä½ˆå±€ */
        #gallery { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .card { background: var(--card); border-radius: 8px; overflow: hidden; position: relative; border: 1.5px solid #333; transition: 0.2s; }
        .card.selected { border-color: var(--primary); }
        
        /* 16:9 æ¯”ä¾‹æ§åˆ¶ */
        .img-container { width: 100%; aspect-ratio: 16 / 9; overflow: hidden; background: #000; position: relative; }
        .card img { width: 100%; height: 100%; object-fit: cover; cursor: pointer; }
        
        .check-overlay { position: absolute; top: 4px; left: 4px; z-index: 10; }
        .check-overlay input { width: 18px; height: 18px; accent-color: var(--primary); }

        .type-label { position: absolute; bottom: 4px; right: 4px; font-size: 9px; padding: 1px 4px; border-radius: 3px; background: rgba(255, 71, 87, 0.8); color: white; }

        .filename { font-size: 9px; padding: 4px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; text-align: center; }

        .download-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #1e1e1e; padding: 12px; border-top: 1px solid #444; z-index: 100; display: none; }
        .btn-main { width: 100%; padding: 14px; background: var(--primary); border: none; border-radius: 10px; color: #fff; font-weight: bold; font-size: 15px; }
    </style>
</head>
<body>

<div class="header">
    <h1>ğŸ“¸ åœ–ç‰‡å°è£ V7 (ä¸‰æ¬„ 16:9)</h1>
    <input type="text" id="actorName" placeholder="è¼¸å…¥æ¼”å“¡å§“å">
    <input type="text" id="urlInput" placeholder="è²¼ä¸Šç¶²å€">
    <button class="btn-main" onclick="fetchImages()" style="padding:10px;">æƒæç¶²é </button>
    <div id="status" style="font-size: 12px; color: #ffa502; text-align: center; margin-top: 8px;"></div>
</div>

<div class="control-btns" id="controlBtns">
    <button class="btn-small" onclick="toggleAll(true)">å…¨é¸å…§å®¹</button>
    <button class="btn-small" onclick="toggleAll(false)">å–æ¶ˆå…¨é¸</button>
</div>

<div id="gallery"></div>

<div id="downloadBar" class="download-bar">
    <button class="btn-main" id="zipBtn" onclick="downloadZip()">å°è£ä¸‹è¼‰ (é¸å– 0 å¼µ)</button>
    <div id="zipStatus" style="font-size: 11px; text-align: center; margin-top: 5px; color: #888;"></div>
</div>

<script>
    let imageList = []; 
    let finalID = ""; 

    async function fetchImages() {
        const actor = document.getElementById('actorName').value.trim() || 'æœªçŸ¥å';
        const url = document.getElementById('urlInput').value.trim();
        const status = document.getElementById('status');
        const gallery = document.getElementById('gallery');
        const downloadBar = document.getElementById('downloadBar');
        const controlBtns = document.getElementById('controlBtns');

        if (!url) return;
        
        const urlParts = url.replace(/\/$/, "").split('/');
        const rawID = urlParts.pop(); 
        const cleanID = rawID.includes('_') ? rawID.split('_').pop() : rawID;
        
        const prefixMatch = cleanID.match(/[a-zA-Z]+/);
        const numberMatch = cleanID.match(/\d+/);
        if (!prefixMatch || !numberMatch) return alert("ç•ªè™Ÿæ ¼å¼åµæ¸¬å¤±æ•—");

        finalID = `${prefixMatch[0].toUpperCase()}-${numberMatch[0].length >= 3 ? numberMatch[0].slice(-3) : numberMatch[0].padStart(3, '0')}`;

        gallery.innerHTML = '';
        imageList = [];
        status.innerText = `è¦æ ¼åŒ–ï¼š${finalID}`;

        try {
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
            const response = await fetch(proxyUrl);
            const html = await response.text();
            const doc = new DOMParser().parseFromString(html, 'text/html');
            const imgs = Array.from(doc.querySelectorAll('img'));

            imgs.forEach((img, index) => {
                let src = img.getAttribute('src') || img.getAttribute('data-src');
                if (!src) return;
                let absUrl = new URL(src, url).href;
                let originalUrl = absUrl.replace(/-\d+x\d+(?=\.(jpg|jpeg|png))/i, '');
                let fileName = decodeURIComponent(originalUrl.split('/').pop().split('?')[0]);

                const isCover = fileName.toLowerCase().includes(rawID.toLowerCase() + 'pl');
                const isContent = fileName.toLowerCase().includes(rawID.toLowerCase() + '_');
                const isThumbnail = fileName.includes('-');

                if ((isCover || isContent) && !isThumbnail) {
                    if (!imageList.find(i => i.url === originalUrl)) {
                        const type = isCover ? 'å°é¢' : 'å…§å®¹';
                        const ext = fileName.split('.').pop();
                        const saveName = isCover ? `å°é¢.${ext}` : fileName.replace(new RegExp(rawID, 'gi'), finalID);
                        
                        const item = { url: originalUrl, saveName, type, actor, finalID, selected: isCover };
                        imageList.push(item);
                        renderCard(item, imageList.length - 1);
                    }
                }
            });

            if (imageList.length > 0) {
                downloadBar.style.display = 'block';
                controlBtns.style.display = 'flex';
                updateDownloadCount();
            }
        } catch (e) { status.innerText = 'æŠ“å–å¤±æ•—'; }
    }

    function renderCard(item, idx) {
        const div = document.createElement('div');
        div.className = `card ${item.selected ? 'selected' : ''}`;
        div.id = `card-${idx}`;
        div.innerHTML = `
            <div class="check-overlay">
                <input type="checkbox" ${item.selected ? 'checked' : ''} 
                       ${item.type === 'å°é¢' ? 'disabled' : ''} 
                       onchange="updateSelection(${idx}, this.checked)">
            </div>
            <div class="img-container">
                <img src="${item.url}" onclick="toggleCard(${idx})" onerror="this.src='https://via.placeholder.com/160x90?text=Error'">
                <span class="type-label">${item.type}</span>
            </div>
            <span class="filename">${item.saveName}</span>
        `;
        document.getElementById('gallery').appendChild(div);
    }

    function updateSelection(idx, isSelected) {
        imageList[idx].selected = isSelected;
        document.getElementById(`card-${idx}`).classList.toggle('selected', isSelected);
        updateDownloadCount();
    }

    function toggleCard(idx) {
        if (imageList[idx].type === 'å°é¢') return;
        const newState = !imageList[idx].selected;
        imageList[idx].selected = newState;
        const cb = document.querySelector(`#card-${idx} input`);
        if (cb) cb.checked = newState;
        document.getElementById(`card-${idx}`).classList.toggle('selected', newState);
        updateDownloadCount();
    }

    function toggleAll(state) {
        imageList.forEach((item, idx) => {
            if (item.type !== 'å°é¢') {
                item.selected = state;
                const cb = document.querySelector(`#card-${idx} input`);
                if (cb) cb.checked = state;
                document.getElementById(`card-${idx}`).classList.toggle('selected', state);
            }
        });
        updateDownloadCount();
    }

    function updateDownloadCount() {
        const count = imageList.filter(i => i.selected).length;
        document.getElementById('zipBtn').innerText = `å°è£ä¸‹è¼‰ (é¸å– ${count} å¼µ)`;
    }

    async function downloadZip() {
        const selectedImages = imageList.filter(i => i.selected);
        if (selectedImages.length === 0) return;

        const zipBtn = document.getElementById('zipBtn');
        const zipStatus = document.getElementById('zipStatus');
        const zip = new JSZip();
        zipBtn.disabled = true;

        try {
            for (let i = 0; i < selectedImages.length; i++) {
                const item = selectedImages[i];
                zipStatus.innerText = `ä¸‹è¼‰ä¸­ (${i + 1}/${selectedImages.length})`;
                const imgResp = await fetch(`https://corsproxy.io/?${encodeURIComponent(item.url)}`);
                const blob = await imgResp.blob();
                zip.file(`${item.actor}/${item.finalID}/${item.saveName}`, blob);
            }
            zipStatus.innerText = 'å°è£å£“ç¸®ä¸­...';
            const content = await zip.generateAsync({ type: "blob" });
            saveAs(content, `${finalID}_${selectedImages[0].actor}.zip`);
            zipStatus.innerText = 'ä¸‹è¼‰å®Œæˆï¼';
        } catch (e) { alert('ä¸‹è¼‰å¤±æ•—'); }
        finally { zipBtn.disabled = false; }
    }
</script>
</body>
</html>
