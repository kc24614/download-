<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>圖片封裝 V43 (16:9 獨立捲動)</title>
    <style>
        :root { --primary: #ff4757; --bg: #0f0f0f; --panel: #1e1e1e; --text: #e0e0e0; }
        * { box-sizing: border-box; }
        body { font-family: "Segoe UI", sans-serif; background: var(--bg); color: var(--text); margin: 0; display: flex; height: 100vh; overflow: hidden; }

        /* 左側邊欄固定 */
        .sidebar { width: 380px; background: var(--panel); border-right: 1px solid #333; display: flex; flex-direction: column; padding: 15px; flex-shrink: 0; z-index: 100; }
        h1 { font-size: 18px; margin: 0 0 15px 0; color: var(--primary); text-align: center; }
        
        #inputGroups { flex: 1; overflow-y: auto; margin-bottom: 15px; padding-right: 5px; }
        .input-card { background: #2a2a2a; border-radius: 8px; padding: 12px; margin-bottom: 15px; border: 1px solid #444; }
        .input-card input { width: 100%; background: #1a1a1a; border: 1px solid #555; color: #ff9f1a; border-radius: 4px; padding: 8px; margin-bottom: 8px; font-weight: bold; }
        .input-card textarea { width: 100%; background: #1a1a1a; border: 1px solid #333; color: #ccc; border-radius: 4px; padding: 8px; height: 80px; font-size: 11px; resize: none; display: block; }
        
        .btn-add-group { width: 100%; padding: 8px; background: #333; border: 1px dashed #666; color: #aaa; border-radius: 6px; cursor: pointer; margin-bottom: 15px; }
        .btn-group-main { display: flex; gap: 8px; margin-bottom: 15px; }
        .btn-scan { flex: 2; padding: 12px; background: var(--primary); border: none; color: #fff; font-weight: bold; border-radius: 6px; cursor: pointer; }
        .btn-clear { flex: 1; padding: 12px; background: #444; border: none; color: #fff; border-radius: 6px; cursor: pointer; }

        .task-container { height: 160px; overflow-y: auto; background: #121212; border-radius: 8px; border: 1px solid #333; }
        .task-item { padding: 10px 12px; border-bottom: 1px solid #222; cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
        .task-item.active { background: #3a1a1c; border-left: 4px solid var(--primary); }

        /* 右側主內容區 */
        .main-content { flex: 1; display: flex; flex-direction: column; background: var(--bg); position: relative; }
        .top-bar { padding: 0 25px; background: #1a1a1a; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #333; height: 60px; flex-shrink: 0; }
        
        /* 修正滾動與佈局：確保向下無限捲動但不重疊 */
        #gallery { 
            flex: 1; 
            overflow-y: scroll; /* 強制顯示垂直捲軸 */
            padding: 25px; 
            display: grid; 
            /* 使用固定最小寬度，防止擠壓 */
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); 
            grid-auto-rows: min-content; /* 內容多高就佔多高，不自動拉伸 */
            gap: 20px; 
            align-content: start; /* 頂部對齊 */
        }

        /* 16:9 穩定卡片 */
        .card { 
            background: #1e1e1e; 
            border-radius: 8px; 
            position: relative; 
            border: 2px solid #333; 
            width: 100%;
            aspect-ratio: 16 / 9; /* 維持 16:9 */
            overflow: hidden;
            display: block; /* 確保作為塊級元素存在 */
        }
        .card.selected { border-color: var(--primary); }
        
        .img-container { 
            width: 100%; 
            height: 100%; 
            background: #000; 
            cursor: zoom-in;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .card img { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; /* 統一預覽比例 */
            display: block;
        }

        /* UI 元件 */
        .check-area { position: absolute; top: 0; right: 0; width: 60px; height: 60px; display: flex; justify-content: flex-end; padding: 10px; cursor: pointer; z-index: 20; }
        .check-box { width: 28px; height: 28px; border-radius: 6px; border: 2px solid #fff; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
        .card.selected .check-box { background: var(--primary); border-color: var(--primary); }
        .card.selected .check-box::after { content: '✓'; color: white; font-size: 16px; font-weight: bold; }
        
        .tag { position: absolute; bottom: 10px; left: 10px; font-size: 11px; padding: 4px 10px; background: rgba(0,0,0,0.8); border-radius: 4px; color: #fff; z-index: 10; pointer-events: none; }

        /* 底部操作列固定 */
        .footer-bar { padding: 15px 30px; background: #1a1a1a; border-top: 1px solid #333; display: none; align-items: center; gap: 20px; flex-shrink: 0; }
        .btn-download { flex: 1; padding: 16px; background: var(--primary); border: none; color: #fff; font-weight: bold; border-radius: 10px; cursor: pointer; font-size: 16px; }
        
        #lightbox { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; align-items: center; justify-content: center; z-index: 10000; }
        #lightbox img { max-width: 98%; max-height: 98%; object-fit: contain; }
    </style>
</head>
<body>

<div class="sidebar">
    <h1>DOWNLOAD V43</h1>
    <div id="inputGroups">
        <div class="input-card">
            <input type="text" placeholder="演員名稱" class="group-actor">
            <textarea placeholder="貼上網址 (一行一個)" class="group-urls"></textarea>
        </div>
        <div class="input-card">
            <input type="text" placeholder="演員名稱" class="group-actor">
            <textarea placeholder="貼上網址 (一行一個)" class="group-urls"></textarea>
        </div>
    </div>
    <button class="btn-add-group" onclick="addGroup()">+ 增加一組演員</button>
    <div class="btn-group-main">
        <button class="btn-scan" onclick="initTasks()">開始批次掃描</button>
        <button class="btn-clear" onclick="clearAll()">清除</button>
    </div>
    <div class="task-container" id="taskList"></div>
</div>

<div class="main-content">
    <div class="top-bar">
        <div id="currentTaskLabel" style="font-weight: bold; color: #ff9f1a;">等待掃描...</div>
        <div id="selectionTools" style="display:none;">
            <button onclick="toggleAll(true)" style="padding:8px 15px; background:#333; color:#ccc; border:1px solid #555; border-radius:6px; font-size:12px; cursor:pointer;">全選內容</button>
            <button onclick="toggleAll(false)" style="padding:8px 15px; background:#333; color:#ccc; border:1px solid #555; border-radius:6px; font-size:12px; margin-left:10px; cursor:pointer;">取消全選</button>
        </div>
    </div>
    
    <div id="gallery"></div>
    
    <div class="footer-bar" id="footerBar">
        <div style="font-size: 18px;">已選擇：<b id="countText" style="color:var(--primary);">0</b> 張</div>
        <button class="btn-download" id="dlBtn" onclick="startDownload()">確認下載 (16:9 捲動版)</button>
    </div>
</div>

<div id="lightbox" onclick="this.style.display='none'"><img id="lbImg"></div>

<script>
    let tasks = [];
    let activeTaskIdx = null;
    const proxy = (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`;

    function addGroup() {
        const container = document.getElementById('inputGroups');
        const div = document.createElement('div');
        div.className = 'input-card';
        div.innerHTML = `<input type="text" placeholder="演員名稱" class="group-actor"><textarea placeholder="貼上網址 (一行一個)" class="group-urls"></textarea>`;
        container.appendChild(div);
    }

    async function initTasks() {
        tasks = [];
        const cards = document.querySelectorAll('.input-card');
        cards.forEach(card => {
            const actor = card.querySelector('.group-actor').value.trim();
            const urls = card.querySelector('.group-urls').value.trim().split('\n');
            if (!actor || urls.length === 0 || (urls.length === 1 && urls[0] === "")) return;
            urls.forEach(url => {
                url = url.trim();
                if (!url.startsWith('http')) return;
                const urlParts = url.replace(/\/$/, "").split('/');
                const rawID = urlParts.pop();
                const cleanID = rawID.includes('_') ? rawID.split('_').pop() : rawID;
                const prefixMatch = cleanID.match(/[a-zA-Z]+/);
                const numberMatch = cleanID.match(/\d+/);
                if (prefixMatch && numberMatch) {
                    const finalID = `${prefixMatch[0].toUpperCase()}-${numberMatch[0].padStart(3, '0').slice(-3)}`;
                    tasks.push({ url, rawID, finalID, actor, images: [], status: 'pending', fetched: false });
                }
            });
        });
        if (tasks.length === 0) return;
        renderTaskList();
        selectTask(0);
    }

    function renderTaskList() {
        const list = document.getElementById('taskList');
        list.innerHTML = tasks.map((t, i) => `
            <div class="task-item ${activeTaskIdx === i ? 'active' : ''}" onclick="selectTask(${i})">
                <div class="task-info"><span class="task-id">${t.finalID}</span> <span style="font-size:11px;color:#888;">(${t.actor})</span></div>
                <div class="status-dot ${t.status === 'done' ? 'done' : ''}"></div>
            </div>`).join('');
    }

    async function selectTask(idx) {
        activeTaskIdx = idx; renderTaskList();
        const task = tasks[idx];
        document.getElementById('currentTaskLabel').innerText = `目前查看：${task.finalID} (${task.actor})`;
        const gallery = document.getElementById('gallery');
        gallery.innerHTML = ''; // 徹底清空，防止殘留
        gallery.scrollTop = 0; // 捲動回頂部
        
        if (!task.fetched) {
            gallery.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding-top:100px; color:#888; font-size:18px;">正在獲取高畫質資源...</div>';
            await fetchImages(task);
        } else { renderGallery(); }
    }

    async function fetchImages(task) {
        try {
            const res = await fetch(proxy(task.url));
            const html = await res.text();
            const doc = new DOMParser().parseFromString(html, 'text/html');
            extractFromDoc(doc, task, task.url);

            let targetLinks = [];
            const walker = document.createTreeWalker(doc.body, NodeFilter.SHOW_TEXT, null, false);
            let node;
            while(node = walker.nextNode()) {
                if (node.textContent.includes('※足裏シーン')) {
                    let sibling = node.parentElement;
                    while(sibling) {
                        const links = sibling.querySelectorAll('a');
                        links.forEach(a => targetLinks.push(new URL(a.getAttribute('href'), task.url).href));
                        sibling = sibling.nextElementSibling;
                    }
                    break;
                }
            }
            if (targetLinks.length === 0) {
                targetLinks = Array.from(doc.querySelectorAll('a')).filter(a => a.querySelector('img')).map(a => new URL(a.getAttribute('href'), task.url).href);
            }

            const uniqueLinks = [...new Set(targetLinks)];
            for (let pageUrl of uniqueLinks) {
                try {
                    const subRes = await fetch(proxy(pageUrl));
                    const subDoc = new DOMParser().parseFromString(await subRes.text(), 'text/html');
                    extractFromDoc(subDoc, task, pageUrl);
                } catch(e) {}
            }
            task.fetched = true;
            renderGallery();
        } catch (e) { document.getElementById('gallery').innerHTML = '解析出錯，請重試'; }
    }

    function extractFromDoc(doc, task, baseUrl) {
        const imgs = Array.from(doc.querySelectorAll('img'));
        imgs.forEach(img => {
            let src = img.getAttribute('src') || img.getAttribute('data-src') || img.getAttribute('data-lazy-src');
            if (!src) return;
            let absUrl = new URL(src, baseUrl).href;
            let originalUrl = absUrl.replace(/-\d+x\d+(?=\.(jpg|jpeg|png))/i, '');
            let fileName = decodeURIComponent(originalUrl.split('/').pop().split('?')[0]);
            const isCover = fileName.toLowerCase().includes(task.rawID.toLowerCase() + 'pl');
            const isContent = fileName.toLowerCase().includes(task.rawID.toLowerCase() + '_');
            const isThumbnail = fileName.includes('-');
            if ((isCover || isContent) && !isThumbnail) {
                if (!task.images.find(m => m.url === originalUrl)) {
                    task.images.push({ url: originalUrl, selected: isCover, type: isCover ? '封面' : '內容' });
                }
            }
        });
    }

    function renderGallery() {
        const task = tasks[activeTaskIdx];
        const gallery = document.getElementById('gallery');
        if (task.images.length === 0) {
            gallery.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding-top:100px; color:#888;">此任務無可提取照片。</div>';
            return;
        }
        gallery.innerHTML = task.images.map((img, i) => `
            <div class="card ${img.selected ? 'selected' : ''}" id="card-${i}">
                <div class="tag">${img.type}</div>
                <div class="check-area" onclick="toggleImg(event, ${i})"><div class="check-box"></div></div>
                <div class="img-container" onclick="openLB('${img.url}')">
                    <img src="${img.url}" loading="lazy">
                </div>
            </div>`).join('');
        document.getElementById('footerBar').style.display = 'flex';
        document.getElementById('selectionTools').style.display = 'block';
        updateCount();
    }

    function toggleImg(e, i) {
        e.stopPropagation();
        const img = tasks[activeTaskIdx].images[i];
        img.selected = !img.selected;
        document.getElementById(`card-${i}`).classList.toggle('selected');
        updateCount();
    }

    function toggleAll(state) {
        tasks[activeTaskIdx].images.forEach((img, i) => {
            if (img.type !== '封面') {
                img.selected = state;
                const card = document.getElementById(`card-${i}`);
                if(card) card.classList.toggle('selected', state);
            }
        });
        updateCount();
    }

    function updateCount() {
        document.getElementById('countText').innerText = tasks[activeTaskIdx].images.filter(i => i.selected).length;
    }

    function openLB(url) {
        document.getElementById('lbImg').src = url;
        document.getElementById('lightbox').style.display = 'flex';
    }

    function clearAll() {
        if(!confirm("確定清空所有輸入與任務？")) return;
        document.querySelectorAll('.group-actor').forEach(i => i.value = '');
        document.querySelectorAll('.group-urls').forEach(i => i.value = '');
        document.getElementById('gallery').innerHTML = '';
        tasks = []; renderTaskList();
        document.getElementById('footerBar').style.display = 'none';
        document.getElementById('selectionTools').style.display = 'none';
    }

    async function startDownload() {
        const task = tasks[activeTaskIdx];
        const selected = task.images.filter(i => i.selected);
        const btn = document.getElementById('dlBtn');
        btn.disabled = true; btn.innerText = "下載發送中...";
        let contentIdx = 1;
        for (let item of selected) {
            const ext = item.url.split('.').pop().split('?')[0];
            let fileName = (item.type === '封面') ? `!${task.finalID}_${task.actor}_封面.${ext}` : `${task.finalID}_${task.actor}_${String(contentIdx++).padStart(2, '0')}.${ext}`;
            try {
                const resp = await fetch(proxy(item.url));
                const blob = await resp.blob();
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob); a.download = fileName; a.click();
                await new Promise(r => setTimeout(r, 600));
            } catch(e) {}
        }
        btn.disabled = false; btn.innerText = "確認下載 (16:9 捲動版)";
        task.status = 'done'; renderTaskList();
    }
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') document.getElementById('lightbox').style.display = 'none'; });
</script>
</body>
</html>
