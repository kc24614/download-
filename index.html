<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>圖片封裝 V8 (一鍵清除版)</title>
    <meta name="theme-color" content="#ff4757">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        :root { --primary: #ff4757; --bg: #121212; --card: #1e1e1e; --gray: #555; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: #fff; margin: 0; padding: 10px; padding-bottom: 120px; }
        
        .header { background: var(--card); padding: 15px; border-radius: 12px; border: 1px solid #333; margin-bottom: 15px; }
        h1 { font-size: 18px; margin: 0 0 12px 0; color: var(--primary); text-align: center; }
        input[type="text"] { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #252525; color: #fff; font-size: 16px; margin-bottom: 10px; outline: none; }
        
        .action-btns { display: flex; gap: 8px; margin-bottom: 10px; }
        .btn-scan { flex: 2; padding: 12px; background: var(--primary); border: none; border-radius: 8px; color: #fff; font-weight: bold; font-size: 15px; cursor: pointer; }
        .btn-clear { flex: 1; padding: 12px; background: var(--gray); border: none; border-radius: 8px; color: #fff; font-weight: bold; font-size: 15px; cursor: pointer; }

        .control-btns { display: flex; gap: 5px; margin-bottom: 15px; display: none; }
        .btn-small { flex: 1; padding: 8px; font-size: 11px; border-radius: 5px; border: 1px solid #444; background: #333; color: #ccc; cursor: pointer; }

        #gallery { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .card { background: var(--card); border-radius: 8px; overflow: hidden; position: relative; border: 1.5px solid #333; }
        .card.selected { border-color: var(--primary); }
        .img-container { width: 100%; aspect-ratio: 16 / 9; overflow: hidden; background: #000; position: relative; }
        .card img { width: 100%; height: 100%; object-fit: cover; }
        
        .check-overlay { position: absolute; top: 4px; left: 4px; z-index: 10; }
        .check-overlay input { width: 18px; height: 18px; accent-color: var(--primary); }
        .type-label { position: absolute; bottom: 4px; right: 4px; font-size: 9px; padding: 1px 4px; border-radius: 3px; background: rgba(255, 71, 87, 0.8); }
        .filename { font-size: 9px; padding: 4px; color: #888; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; text-align: center; }

        .download-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #1e1e1e; padding: 12px; border-top: 1px solid #444; z-index: 100; display: none; }
        .btn-main { width: 100%; padding: 14px; background: var(--primary); border: none; border-radius: 10px; color: #fff; font-weight: bold; font-size: 15px; }
    </style>
</head>
<body>

<div class="header">
    <h1>DOWNLOAD</h1>
    <input type="text" id="actorName" placeholder="輸入演員姓名">
    <input type="text" id="urlInput" placeholder="貼上網址">
    
    <div class="action-btns">
        <button class="btn-scan" onclick="fetchImages()">掃描圖片</button>
        <button class="btn-clear" onclick="clearAll()">一鍵清除</button>
    </div>
    
    <div id="status" style="font-size: 12px; color: #ffa502; text-align: center; margin-top: 5px;"></div>
</div>

<div class="control-btns" id="controlBtns">
    <button class="btn-small" onclick="toggleAll(true)">全選內容</button>
    <button class="btn-small" onclick="toggleAll(false)">取消全選</button>
</div>

<div id="gallery"></div>

<div id="downloadBar" class="download-bar">
    <button class="btn-main" id="zipBtn" onclick="downloadZip()">封裝下載 (選取 0 張)</button>
    <div id="zipStatus" style="font-size: 11px; text-align: center; margin-top: 5px; color: #888;"></div>
</div>

<script>
    let imageList = []; 
    let finalID = ""; 

    function clearAll() {
        document.getElementById('actorName').value = '';
        document.getElementById('urlInput').value = '';
        document.getElementById('gallery').innerHTML = '';
        document.getElementById('status').innerText = '';
        document.getElementById('downloadBar').style.display = 'none';
        document.getElementById('controlBtns').style.display = 'none';
        document.getElementById('zipStatus').innerText = '';
        imageList = [];
        finalID = "";
        document.getElementById('actorName').focus(); // 自動聚焦回第一個輸入框
    }

    async function fetchImages() {
        const actor = document.getElementById('actorName').value.trim() || '未知名';
        const url = document.getElementById('urlInput').value.trim();
        const status = document.getElementById('status');
        const gallery = document.getElementById('gallery');
        const downloadBar = document.getElementById('downloadBar');
        const controlBtns = document.getElementById('controlBtns');

        if (!url) return;
        
        const urlParts = url.replace(/\/$/, "").split('/');
        const rawID = urlParts.pop(); 
        const cleanID = rawID.includes('_') ? rawID.split('_').pop() : rawID;
        
        const prefixMatch = cleanID.match(/[a-zA-Z]+/);
        const numberMatch = cleanID.match(/\d+/);
        if (!prefixMatch || !numberMatch) return alert("番號格式偵測失敗");

        finalID = `${prefixMatch[0].toUpperCase()}-${numberMatch[0].length >= 3 ? numberMatch[0].slice(-3) : numberMatch[0].padStart(3, '0')}`;

        gallery.innerHTML = '';
        imageList = [];
        status.innerText = `格式化：${finalID}`;

        try {
            const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(url)}`;
            const response = await fetch(proxyUrl);
            const html = await response.text();
            const doc = new DOMParser().parseFromString(html, 'text/html');
            const imgs = Array.from(doc.querySelectorAll('img'));

            imgs.forEach((img, index) => {
                let src = img.getAttribute('src') || img.getAttribute('data-src');
                if (!src) return;
                let absUrl = new URL(src, url).href;
                let originalUrl = absUrl.replace(/-\d+x\d+(?=\.(jpg|jpeg|png))/i, '');
                let fileName = decodeURIComponent(originalUrl.split('/').pop().split('?')[0]);

                const isCover = fileName.toLowerCase().includes(rawID.toLowerCase() + 'pl');
                const isContent = fileName.toLowerCase().includes(rawID.toLowerCase() + '_');
                const isThumbnail = fileName.includes('-');

                if ((isCover || isContent) && !isThumbnail) {
                    if (!imageList.find(i => i.url === originalUrl)) {
                        const type = isCover ? '封面' : '內容';
                        const ext = fileName.split('.').pop();
                        const saveName = isCover ? `封面.${ext}` : fileName.replace(new RegExp(rawID, 'gi'), finalID);
                        
                        const item = { url: originalUrl, saveName, type, actor, finalID, selected: isCover };
                        imageList.push(item);
                        renderCard(item, imageList.length - 1);
                    }
                }
            });

            if (imageList.length > 0) {
                downloadBar.style.display = 'block';
                controlBtns.style.display = 'flex';
                updateDownloadCount();
            } else {
                status.innerText = '找不到符合規則的圖片';
            }
        } catch (e) { status.innerText = '抓取失敗'; }
    }

    function renderCard(item, idx) {
        const div = document.createElement('div');
        div.className = `card ${item.selected ? 'selected' : ''}`;
        div.id = `card-${idx}`;
        div.innerHTML = `
            <div class="check-overlay"><input type="checkbox" ${item.selected ? 'checked' : ''} ${item.type === '封面' ? 'disabled' : ''} onchange="updateSelection(${idx}, this.checked)"></div>
            <div class="img-container">
                <img src="${item.url}" onclick="toggleCard(${idx})" onerror="this.src='https://via.placeholder.com/160x90?text=Error'">
                <span class="type-label">${item.type}</span>
            </div>
            <span class="filename">${item.saveName}</span>
        `;
        document.getElementById('gallery').appendChild(div);
    }

    function updateSelection(idx, isSelected) {
        imageList[idx].selected = isSelected;
        document.getElementById(`card-${idx}`).classList.toggle('selected', isSelected);
        updateDownloadCount();
    }

    function toggleCard(idx) {
        if (imageList[idx].type === '封面') return;
        const newState = !imageList[idx].selected;
        imageList[idx].selected = newState;
        const cb = document.querySelector(`#card-${idx} input`);
        if (cb) cb.checked = newState;
        document.getElementById(`card-${idx}`).classList.toggle('selected', newState);
        updateDownloadCount();
    }

    function toggleAll(state) {
        imageList.forEach((item, idx) => {
            if (item.type !== '封面') {
                item.selected = state;
                const cb = document.querySelector(`#card-${idx} input`);
                if (cb) cb.checked = state;
                document.getElementById(`card-${idx}`).classList.toggle('selected', state);
            }
        });
        updateDownloadCount();
    }

    function updateDownloadCount() {
        const count = imageList.filter(i => i.selected).length;
        document.getElementById('zipBtn').innerText = `封裝下載 (選取 ${count} 張)`;
    }

    async function downloadZip() {
        const selectedImages = imageList.filter(i => i.selected);
        if (selectedImages.length === 0) return;
        const zipBtn = document.getElementById('zipBtn');
        const zipStatus = document.getElementById('zipStatus');
        const zip = new JSZip();
        zipBtn.disabled = true;
        try {
            for (let i = 0; i < selectedImages.length; i++) {
                const item = selectedImages[i];
                zipStatus.innerText = `下載中 (${i + 1}/${selectedImages.length})`;
                const imgResp = await fetch(`https://corsproxy.io/?${encodeURIComponent(item.url)}`);
                const blob = await imgResp.blob();
                zip.file(`${item.actor}/${item.finalID}/${item.saveName}`, blob);
            }
            zipStatus.innerText = '壓縮中...';
            const content = await zip.generateAsync({ type: "blob" });
            saveAs(content, `${finalID}_${selectedImages[0].actor}.zip`);
            zipStatus.innerText = '完成！';
        } catch (e) { alert('失敗'); }
        finally { zipBtn.disabled = false; }
    }
</script>
</body>
</html>
